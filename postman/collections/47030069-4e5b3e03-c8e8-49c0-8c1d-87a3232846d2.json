{
	"info": {
		"_postman_id": "47030069-4e5b3e03-c8e8-49c0-8c1d-87a3232846d2",
		"name": "MBbank N·∫°p ti·ªÅn t·ª± ƒë·ªông",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "MBBank_Identify",
			"item": [
				{
					"name": "MBBank_Identify",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"id": "e8171ef1-86f9-43af-8a18-8fb035319a5f",
								"exec": [
									""
								],
								"type": "text/javascript",
								"packages": {}
							}
						},
						{
							"listen": "test",
							"script": {
								"id": "96b0496d-3a20-4fd6-bb1e-7eeb62f79b1d",
								"exec": [
									""
								],
								"type": "text/javascript",
								"packages": {}
							}
						}
					],
					"id": "47030069-c66cdb2c-eea9-4a06-8217-ece201e90a40",
					"protocolProfileBehavior": {
						"disableBodyPruning": true
					},
					"request": {
						"auth": {
							"type": "noauth"
						},
						"method": "POST",
						"header": [],
						"body": {
							"mode": "raw",
							"raw": "{{finalBody}}\r\n",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "http://192.168.1.9:44204/api/v1/order-update",
							"protocol": "http",
							"host": [
								"192",
								"168",
								"1",
								"9"
							],
							"port": "44204",
							"path": [
								"api",
								"v1",
								"order-update"
							]
						}
					},
					"response": []
				}
			],
			"id": "47030069-e89b0ecc-f87e-4d57-b069-864844eae363",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "bafd39c2-27ed-447f-8f54-6a9adb7f2746",
						"type": "text/javascript",
						"packages": {},
						"exec": [
							"// ====== Helper sinh random ======\r",
							"function generateRandomId(length) {\r",
							"    let result = '';\r",
							"    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\r",
							"    for (let i = 0; i < length; i++) {\r",
							"        result += characters.charAt(Math.floor(Math.random() * characters.length));\r",
							"    }\r",
							"    return result;\r",
							"}\r",
							"\r",
							"// ====== Helper: Generate GUID JS thu·∫ßn ======\r",
							"function generateGuid() {\r",
							"    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\r",
							"        let r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);\r",
							"        return v.toString(16);\r",
							"    });\r",
							"}\r",
							"\r",
							"// ====== Helper: l·∫•y t·ª´ CSV v·ªõi 3 ch·∫ø ƒë·ªô (gi√° tr·ªã c·ª• th·ªÉ / \"null\" / √¥ tr·ªëng) ======\r",
							"function getSmartValue(field, defaultVal) {\r",
							"    let csvValue = pm.iterationData.get(field);\r",
							"\r",
							"    if (csvValue !== undefined && csvValue !== null) {\r",
							"        let val = csvValue.toString().trim();\r",
							"\r",
							"        if (val.toLowerCase() === \"null\") {\r",
							"            return null;  // null th·∫≠t trong JSON\r",
							"        }\r",
							"        if (val !== \"\") {\r",
							"            return val; // gi·ªØ nguy√™n gi√° tr·ªã CSV\r",
							"        }\r",
							"    }\r",
							"\r",
							"    // n·∫øu CSV tr·ªëng -> l·∫•y default\r",
							"    let def = (typeof defaultVal === \"function\") ? defaultVal() : defaultVal;\r",
							"    return def === undefined ? null : def;\r",
							"}\r",
							"\r",
							"// ====== Sinh d·ªØ li·ªáu ƒë·ªông ======\r",
							"const requestId       = getSmartValue(\"requestId\", generateGuid);\r",
							"const referenceNumber = getSmartValue(\"referenceNumber\", generateGuid);\r",
							"const amount          = getSmartValue(\"amount\", \"10000.00\");\r",
							"const customerAcc     = getSmartValue(\"customerAcc\", \"MBIRIS001\");\r",
							"\r",
							"const currentDate = new Date();\r",
							"currentDate.setHours(currentDate.getHours() + 7);\r",
							"const transDate = getSmartValue(\"transDate\", () => currentDate.toISOString().slice(0, 19).replace('T', ' '));\r",
							"\r",
							"const billNumber   = getSmartValue(\"billNumber\", () => generateRandomId(10));\r",
							"const userName     = getSmartValue(\"userName\", \"thuthu\");\r",
							"const customerName = getSmartValue(\"customerName\", \"Thu Thu\");\r",
							"let signature      = getSmartValue(\"signature\", null); // s·∫Ω t·ª± k√Ω n·∫øu tr·ªëng\r",
							"\r",
							"// ====== Fake object ƒë·ªÉ jsrsasign ch·∫°y ======\r",
							"var navigator = {};\r",
							"var window = {};\r",
							"var forge = {};\r",
							"\r",
							"// ====== H√†m k√Ω s·ªë ======\r",
							"function createSignature(dataToSign) {\r",
							"    try {\r",
							"        const jsrsasign = pm.globals.get(\"jsrsasign\") || pm.environment.get(\"jsrsasign\");\r",
							"        if (!jsrsasign) {\r",
							"            throw new Error(\"jsrsasign library not found. H√£y th√™m jsrsasign-all-min.js v√†o Globals/Env.\");\r",
							"        }\r",
							"        eval(jsrsasign);\r",
							"\r",
							"        const privateKeyPem = pm.environment.get(\"privateKeyPem\");\r",
							"        if (!privateKeyPem) {\r",
							"            throw new Error(\"Ch∆∞a c·∫•u h√¨nh privateKeyPem trong Environment\");\r",
							"        }\r",
							"\r",
							"        const rsa = new KJUR.crypto.Signature({ alg: \"SHA256withRSA\" });\r",
							"        const privateKey = KEYUTIL.getKey(privateKeyPem);\r",
							"        rsa.init(privateKey);\r",
							"        rsa.updateString(dataToSign);\r",
							"\r",
							"        return CryptoJS.enc.Base64.stringify(\r",
							"            CryptoJS.enc.Hex.parse(rsa.sign())\r",
							"        );\r",
							"\r",
							"    } catch (err) {\r",
							"        console.error(\"Error creating signature:\", err.message);\r",
							"        return null;\r",
							"    }\r",
							"}\r",
							"\r",
							"// ====== Auto-sign n·∫øu signature ƒë·ªÉ tr·ªëng ======\r",
							"if (signature === null) {\r",
							"    const dataToSign = referenceNumber + customerAcc + amount + transDate;\r",
							"    signature = createSignature(dataToSign);\r",
							"}\r",
							"\r",
							"// ====== Build final JSON body ======\r",
							"const finalBody = {\r",
							"    requestId: requestId,\r",
							"    signature: signature,\r",
							"    data: {\r",
							"        referenceNumber: referenceNumber,\r",
							"        amount: amount,\r",
							"        customerAcc: customerAcc,\r",
							"        transDate: transDate,\r",
							"        billNumber: billNumber,\r",
							"        userName: userName,\r",
							"        customerName: customerName,\r",
							"        additionalData: [\r",
							"            {\r",
							"                value: \"Nap tien tai khoan hu de\",\r",
							"                name: \"remark\"\r",
							"            }\r",
							"        ]\r",
							"    }\r",
							"};\r",
							"\r",
							"// ====== Set v√†o bi·∫øn ƒë·ªÉ body ch·ªâ c·∫ßn {{finalBody}} ======\r",
							"pm.variables.set(\"finalBody\", JSON.stringify(finalBody));\r",
							""
						]
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "a204c315-c855-4328-8c25-d9f28a59446e",
						"type": "text/javascript",
						"packages": {},
						"exec": [
							"// ==== Parse response ====\r",
							"let jsonData;\r",
							"try {\r",
							"    jsonData = pm.response.json();\r",
							"} catch (e) {\r",
							"    pm.test(\"Ph·∫£n h·ªìi ph·∫£i l√† JSON h·ª£p l·ªá\", function () {\r",
							"        pm.expect.fail(\"Kh√¥ng parse ƒë∆∞·ª£c JSON: \" + e.message);\r",
							"    });\r",
							"    return;\r",
							"}\r",
							"\r",
							"// ==== Testcase name t·ª´ CSV ====\r",
							"const testcaseName = pm.iterationData.get(\"TestcaseName\") || \"Unnamed Testcase\";\r",
							"\r",
							"// ==== Log Request & Response ƒë·ªÉ debug ====\r",
							"console.log(\"=== Testcase:\", testcaseName, \"===\");\r",
							"console.log(\"üëâ Request Body:\", pm.request.body.raw);\r",
							"console.log(\"üëâ Response Body:\", pm.response.text());\r",
							"\r",
							"// ==== Check c·∫•u tr√∫c chu·∫©n ====\r",
							"pm.test('Response c√≥ ƒë·ªß c·∫•u tr√∫c', function () {\r",
							"    pm.expect(jsonData).to.be.an('object');\r",
							"    pm.expect(jsonData).to.have.all.keys('requestId', 'data', 'signature');\r",
							"    pm.expect(jsonData.data).to.have.property(\"transactionId\");\r",
							"    pm.expect(jsonData.data).to.have.property(\"responseCode\");\r",
							"    pm.expect(jsonData.data).to.have.property(\"responseDesc\");\r",
							"});\r",
							"\r",
							"// ==== Expected t·ª´ CSV ====\r",
							"const expectedResponseCode = pm.iterationData.get(\"responseCode\");\r",
							"const expectedResponseDesc = pm.iterationData.get(\"responseDesc\");\r",
							"\r",
							"// ==== HTTP status ====\r",
							"pm.test(\"HTTP status ph·∫£i l√† 200\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});\r",
							"\r",
							"// ==== Check responseCode ƒë·ªông ====\r",
							"if (expectedResponseCode) {\r",
							"    pm.test(\"responseCode ph·∫£i kh·ªõp CSV (\" + testcaseName + \")\", function () {\r",
							"        pm.expect(jsonData.data.responseCode).to.eql(expectedResponseCode);\r",
							"    });\r",
							"} else {\r",
							"    pm.test(\"responseCode m·∫∑c ƒë·ªãnh = 00\", function () {\r",
							"        pm.expect(jsonData.data.responseCode).to.eql(\"00\");\r",
							"    });\r",
							"}\r",
							"\r",
							"// ==== Check responseDesc ƒë·ªông ====\r",
							"if (expectedResponseDesc) {\r",
							"    pm.test(\"responseDesc ph·∫£i kh·ªõp CSV (\" + testcaseName + \")\", function () {\r",
							"        pm.expect(jsonData.data.responseDesc).to.eql(expectedResponseDesc);\r",
							"    });\r",
							"}\r",
							""
						]
					}
				}
			]
		}
	]
}